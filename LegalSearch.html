<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .tab-btn { white-space: nowrap; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 500; font-size: 13px; padding: 10px 16px; transition: all 0.2s; }
    .tab-btn.active { border-color: #059669; color: #059669; background-color: #ecfdf5; }
    .doc-card:active { transform: scale(0.98); background-color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen flex flex-col overflow-hidden select-none font-sans">

  <div class="bg-white shadow-sm z-10 flex-none">
    <div class="p-4 flex justify-between items-center bg-slate-800 text-white">
        <h2 class="font-bold flex items-center gap-2 text-lg">
            <i class="ph-fill ph-gavel text-2xl text-yellow-400"></i> Tra Cứu Luật EHS
        </h2>
        <button onclick="closeModule()" class="text-gray-400 hover:text-white p-2"><i class="ph ph-x text-2xl"></i></button>
    </div>

    <div class="p-3">
        <div class="relative">
            <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400 text-lg"></i>
            <input type="text" id="search-input" onkeyup="renderData()" 
                   class="w-full pl-10 pr-10 py-2.5 rounded-lg border border-gray-200 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 outline-none text-sm transition" 
                   placeholder="Tìm tên văn bản, nghị định...">
            <button onclick="document.getElementById('search-input').value=''; renderData()" class="absolute right-3 top-3 text-gray-400 hover:text-red-500"><i class="ph-fill ph-x-circle"></i></button>
        </div>
    </div>

    <div class="flex overflow-x-auto no-scrollbar border-b border-gray-100 px-2" id="category-tabs">
        <button onclick="switchTab('ALL')" class="tab-btn active" id="tab-ALL">Tất cả</button>
        <button onclick="switchTab('Hóa chất')" class="tab-btn" id="tab-Hóa chất">Hóa chất</button>
        <button onclick="switchTab('Môi trường')" class="tab-btn" id="tab-Môi trường">Môi trường</button>
        <button onclick="switchTab('PCCC')" class="tab-btn" id="tab-PCCC">PCCC</button>
        <button onclick="switchTab('An toàn vệ sinh lao động')" class="tab-btn" id="tab-ATVSLD">An toàn LĐ</button>
        <button onclick="switchTab('Yêu cầu khác')" class="tab-btn" id="tab-Yêu cầu khác">Khác</button>
    </div>
  </div>

  <div id="doc-list" class="flex-1 overflow-y-auto p-3 space-y-3 pb-20">
      <div class="mt-20 text-center text-gray-400">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mx-auto mb-2"></div>
          <span class="text-xs">Đang tải dữ liệu luật...</span>
      </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity" onclick="closeModal()">
      <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-xl p-5 transform transition-transform translate-y-full sm:translate-y-0" id="modal-panel" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4">
              <div>
                  <span id="m-category" class="text-[10px] font-bold uppercase tracking-wider text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100">...</span>
                  <h3 id="m-name" class="text-lg font-bold text-slate-800 mt-2 leading-snug">...</h3>
                  <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                      <i class="ph-fill ph-calendar-check"></i> Hiệu lực: <span id="m-date" class="font-medium text-slate-700">...</span>
                  </div>
              </div>
              <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full text-gray-500 hover:bg-gray-200"><i class="ph-bold ph-x"></i></button>
          </div>

          <div class="space-y-3 pt-2">
              <a id="btn-pdf" href="#" target="_blank" class="flex items-center justify-between p-3 rounded-xl border border-red-100 bg-red-50 text-red-700 hover:bg-red-100 transition">
                  <div class="flex items-center gap-3">
                      <div class="bg-white p-2 rounded-lg shadow-sm"><i class="ph-fill ph-file-pdf text-2xl text-red-500"></i></div>
                      <span class="font-bold text-sm">Xem bản PDF</span>
                  </div>
                  <i class="ph-bold ph-arrow-square-out text-lg"></i>
              </a>
              
              <a id="btn-word" href="#" target="_blank" class="flex items-center justify-between p-3 rounded-xl border border-blue-100 bg-blue-50 text-blue-700 hover:bg-blue-100 transition">
                  <div class="flex items-center gap-3">
                      <div class="bg-white p-2 rounded-lg shadow-sm"><i class="ph-fill ph-file-doc text-2xl text-blue-500"></i></div>
                      <span class="font-bold text-sm">Tải bản Word</span>
                  </div>
                  <i class="ph-bold ph-download-simple text-lg"></i>
              </a>
          </div>
          <div class="text-center mt-4 text-[10px] text-gray-400">Nhấn ra ngoài để đóng</div>
      </div>
  </div>

  <script>
    let gLegalData = [];
    let gCurrentTab = 'ALL';

    // --- KHỞI TẠO ---
    function init() {
        google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onError)
            .getLegalData();
    }
    
    function onSuccess(json) {
        try {
            const data = JSON.parse(json);
            if (data.error) throw new Error(data.message);
            gLegalData = data;
            renderData();
        } catch (e) { onError(e.message); }
    }

    function onError(msg) {
        document.getElementById('doc-list').innerHTML = `<div class="text-center text-red-500 mt-10 p-4 border border-dashed border-red-300 rounded bg-red-50"><i class="ph-fill ph-warning-circle text-3xl mb-2"></i><br>${msg}</div>`;
    }

    // --- RENDER DỮ LIỆU ---
    function switchTab(tabName) {
        gCurrentTab = tabName;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        // Xử lý ID đặc biệt cho tab có dấu
        let tabId = tabName;
        if(tabName === 'An toàn vệ sinh lao động') tabId = 'ATVSLD';
        
        const activeBtn = document.getElementById('tab-' + tabId) || document.getElementById('tab-' + tabName);
        if(activeBtn) activeBtn.classList.add('active');
        
        renderData();
    }

    function renderData() {
        const container = document.getElementById('doc-list');
        const search = removeAccents(document.getElementById('search-input').value.toLowerCase());
        
        const filtered = gLegalData.filter(item => {
            // Lọc theo Tab
            if (gCurrentTab !== 'ALL' && item.category !== gCurrentTab) return false;
            // Lọc theo Search
            if (search) {
                return removeAccents(item.name.toLowerCase()).includes(search);
            }
            return true;
        });

        if (filtered.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center mt-10 text-gray-400 opacity-60"><i class="ph-duotone ph-magnifying-glass text-5xl mb-2"></i><p class="text-sm">Không tìm thấy văn bản nào</p></div>`;
            return;
        }

        let html = '';
        filtered.forEach(item => {
            // Chọn icon tùy theo lĩnh vực
            let iconClass = 'ph-file-text text-gray-500';
            let bgClass = 'bg-gray-100';
            
            if(item.category.includes('PCCC')) { iconClass = 'ph-fire text-red-500'; bgClass = 'bg-red-50'; }
            else if(item.category.includes('Hóa chất')) { iconClass = 'ph-flask text-purple-500'; bgClass = 'bg-purple-50'; }
            else if(item.category.includes('Môi trường')) { iconClass = 'ph-plant text-emerald-500'; bgClass = 'bg-emerald-50'; }
            else if(item.category.includes('An toàn')) { iconClass = 'ph-hard-hat text-orange-500'; bgClass = 'bg-orange-50'; }

            html += `
            <div class="doc-card bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-start gap-3 cursor-pointer" onclick='openModal(${JSON.stringify(item)})'>
                <div class="flex-none w-10 h-10 ${bgClass} rounded-full flex items-center justify-center mt-1">
                    <i class="ph-fill ${iconClass} text-xl"></i>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">${item.category}</span>
                        <span class="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100">${item.date}</span>
                    </div>
                    <h4 class="font-semibold text-sm text-slate-800 leading-snug mt-0.5 line-clamp-2">${item.name}</h4>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    // --- MODAL ---
    function openModal(item) {
        document.getElementById('m-category').innerText = item.category;
        document.getElementById('m-name').innerText = item.name;
        document.getElementById('m-date').innerText = item.date || "N/A";
        
        setupBtn('btn-pdf', item.linkPdf);
        setupBtn('btn-word', item.linkWord);

        const modal = document.getElementById('modal');
        const panel = document.getElementById('modal-panel');
        modal.classList.remove('hidden');
        setTimeout(() => panel.classList.remove('translate-y-full'), 10);
    }

    function setupBtn(id, link) {
        const btn = document.getElementById(id);
        if (link && link.startsWith('http')) {
            btn.href = link;
            btn.classList.remove('hidden');
        } else {
            btn.classList.add('hidden');
        }
    }

    function closeModal() {
        const modal = document.getElementById('modal');
        const panel = document.getElementById('modal-panel');
        panel.classList.add('translate-y-full');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    function closeModule() {
       if (typeof loadDataFromSheet === 'function') loadDataFromSheet(); 
       else window.top.location.reload();
    }

    function removeAccents(str) {
        return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd').replace(/Đ/g, 'D');
    }

    init(); // Gọi hàm luôn, không cần chờ window.onload
  </script>
</body>
</html>
